<div class="flex">
  <!-- Sidebar -->
  <aside class="w-64 border-r pr-4">
    <h3 class="text-lg font-semibold mb-1">
      <%= link_to @playlist.name, playlist_path(@playlist), class: "text-blue-600 hover:underline" %>
    </h3>
    <p class="text-sm text-gray-500 mb-3">Songs</p>
    <ul class="space-y-1">
      <% @playlist.songs.rank(:row_order).each do |song_item| %>
        <li>
          <%= link_to playlist_song_path(@playlist, song_item), class: "block px-2 py-1 rounded hover:bg-gray-100 #{'bg-blue-100 font-semibold' if song_item == @song}" do %>
            <%= song_item.name %>
          <% end %>
        </li>
      <% end %>
    </ul>
  </aside>

  <!-- Main content -->
  <main class="flex-1 pl-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-2xl font-bold"><%= @song.name %></h2>
        <p><strong>BPM:</strong> <%= @song.bpm %></p>
        <p><strong>Time Signature:</strong> <%= @song.time_signature %></p>
      </div>
      <div class="space-x-2">
        <%= link_to "‚úèÔ∏è Edit", edit_playlist_song_path(@playlist, @song), class: "text-yellow-600 hover:underline" %>
        <%= link_to "üéµ Manage Assets", playlist_song_assets_path(@playlist, @song), class: "text-green-600 hover:underline" %>
        <%= link_to "‚Üê Back to Playlist", playlist_path(@playlist), class: "text-blue-600 hover:underline" %>
      </div>
    </div>

    <% if @song.lyrics.present? %>
      <div class="mb-6" data-controller="lyrics">
        <h3 class="text-lg font-semibold mb-1">Lyrics</h3>
        <pre data-lyrics-target="container" class="whitespace-pre-wrap bg-gray-50 p-4 rounded border overflow-y-auto text-2xl h-[calc(2rem*10)]"><%= @song.lyrics %></pre>
      </div>
    <% end %>

    <div
      data-controller="metronome"
      data-metronome-playlist-id-value="<%= @playlist.id %>"
      data-metronome-song-id-value="<%= @song.id %>"
      data-metronome-songs-json-value="<%= @playlist.songs.order(:row_order).map { |s| { id: s.id, url: playlist_song_path(@playlist, s) } }.to_json %>"
    >
      <input type="hidden" data-metronome-target="bpm" value="<%= @song.bpm %>">
      <input type="hidden" data-metronome-target="timeSignature" value="<%= @song.time_signature %>">

      <button
        data-action="click->metronome#toggle"
        data-metronome-target="toggleButton"
        class="bg-green-600 text-white px-4 py-2 rounded mt-4"
      >
        <span data-playing-hidden>‚ñ∂Ô∏è Start</span>
        <span data-playing-shown style="display: none;">‚èπ Stop</span>
      </button>

      <div class="mt-4">
        <label for="volume">Volume</label>
        <input
          id="volume"
          type="range"
          min="0"
          max="1"
          step="0.01"
          value="1"
          data-action="input->metronome#setVolume"
          data-metronome-target="volume"
        >
      </div>
    </div>

    <% if @song.assets.any? %>
      <div data-controller="song-assets-hint">
        <div class="mt-6">
          <h3 class="text-lg font-semibold mb-2">Song Reference Tracks</h3>
          <ul class="space-y-3">
            <% @song.assets.rank(:row_order).each do |asset| %>
              <li class="flex items-center space-x-4">
                <span class="min-w-24 text-gray-700"><%= asset.name.presence || "Track" %></span>
                <% if asset.file.attached? %>
                  <audio
                    controls
                    style="height: 32px;"
                    data-song-assets-hint-target="audio"
                  >
                    <source src="<%= url_for(asset.file) %>" type="<%= asset.file.content_type %>">
                    Your browser does not support the audio element.
                  </audio>
                <% else %>
                  <span class="text-gray-400">No audio file</span>
                <% end %>
              </li>
            <% end %>
          </ul>
          <div class="text-xs text-gray-500 mt-2">
            Keyboard shortcuts: <strong>1‚Äì9</strong> = play reference, <strong>S</strong> = stop all
          </div>
        </div>
      </div>
    <% end %>
  </main>
</div>
